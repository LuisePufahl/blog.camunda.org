<!DOCTYPE html>
<html class="no-js" lang="en-us" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>

  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

  <meta name="viewport" content="width=device-width" />

  

  <title>Fluent API for Message Correlation | Camunda BPM</title>


  <link rel="canonical" href="http://localhost:1313/post/2014/03/fluent-api-for-message-correlation/">

  

  <meta name="generator" content="Hugo 0.15-camunda" />

  <link type="text/css" rel="stylesheet" href="http://localhost:1313/css/styles.css" />
  <link href='http://localhost:1313/favicon.ico' rel='icon' type='image/x-icon'/>
</head>
<body class="">

<header>
  <div>
    <h1>
      <a class="site-link" href="http://localhost:1313/">
        <span class="bpmn-icon-bpmn-io"></span>
        <span class="site-title">Camunda Team Blog</span>
      </a>
    </h1>

    <nav class="categories">
      <ul>
        <li>
          <a href="http://localhost:1313/categories/modeling">Modeling</a>
        </li>
        <li>
          <a href="http://localhost:1313/categories/execution">Execution</a>
        </li>
        <li>
          <a href="http://localhost:1313/categories/community">Community</a>
        </li>
      </ul>
    </nav>
  </div>
</header>

<div class="page-wrapper">


  <div class="page-content post">
    <article>
      <header class="row">
  <h1><a href="/post/2014/03/fluent-api-for-message-correlation/">Fluent API for Message Correlation</a></h1>

  <div class="meta">
    Written by <a href="#author-badge" class="author">Daniel Meyer</a>
    on <time pubdate="0001-01-01 00:00:00 &#43;0000 UTC">Wed, 17 Mar 17030</time>,
    under <a href="http://localhost:1313/categories/execution">Execution</a> category.
    
  </div>

</header>


      <div class="content">
        <div>
camunda BPM 7.1.0-alpha4 features a new fluent API for message correlation.<br />
<br />
BPMN 2.0 defines events and tasks catching messages. The following is a fragment of a process waiting for an order to be cancelled:<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-S9HlEghrT28/UyadSyDG3oI/AAAAAAAAAXA/Tc7v-ug7mzo/s1600/message-example.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://3.bp.blogspot.com/-S9HlEghrT28/UyadSyDG3oI/AAAAAAAAAXA/Tc7v-ug7mzo/s1600/message-example.png" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Intermediate&nbsp;Message Catch Event</td></tr>
</tbody></table>
In BPMN 2.0 XML you have to provide a name for the message you want to catch:<br />
<br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&lt;bpmn2:definitions ...&gt;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; ...</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &lt;bpmn2:message id="<b>Message_1</b>" name="<b>orderCancelled</b>"/&gt;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; ...</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &lt;bpmn2:process id="Process_1" isExecutable="false"&gt;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; ...</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &lt;bpmn2:intermediateCatchEvent id="IntermediateCatchEvent_2" name="Order &amp;#xA;Cancelled"&gt; &nbsp; &nbsp; &nbsp; <br />&nbsp; &nbsp; &nbsp; &lt;bpmn2:messageEventDefinition messageRef="<b>Message_1</b>"/&gt;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp; &lt;/bpmn2:intermediateCatchEvent&gt;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &nbsp;&nbsp;</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;">&nbsp; &lt;/bpmn2:process&gt;</span><br />
<div>
<br />
<h3>
New Fluent API</h3>
</div>
camunda Engine now featues a fluent DSL for correlating this message to the process engine:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; runtimeService.createMessageCorrelation("<b>orderCancelled</b>")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .processInstanceBusinessKey("someOrderId")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .setVariable("CANCEL_REASON", "someReason")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .setVariable("CANCEL_TIMESTAMP", new Date())</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .correlate();</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span>
<span style="font-family: inherit;">The fluent DSL makes it easy to define a complex correlation set based on different restrictions. The above example correlates the message on the business key. On top of that, correlation based on process variables and process instance id is supported:</span><br />
<span style="font-family: inherit;"><br /></span>
<span style="font-family: Courier New, Courier, monospace;">&nbsp; runtimeService.createMessageCorrelation("<b>orderCancelled</b>")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .processInstanceVariableEquals("orderId", "someOrderId")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .processInstanceVariableEquals("customerId", "someCustomerId")</span><br />
<div>
<span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; .correlate();</span></div>
<span style="font-family: inherit;"><br /></span>
<span style="font-family: Courier New, Courier, monospace;">&nbsp; runtimeService.createMessageCorrelation("<b>orderCancelled</b>")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .processInstanceId("someProcessInstanceId")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; &nbsp; .correlate();</span><br />
<span style="font-family: Courier New, Courier, monospace; font-size: x-small;"><br /></span>
The API also makes it easy to provide the message payload as a single or multiple variables through <span style="font-family: Courier New, Courier, monospace;">setVariable(varName, value)</span>.<br />
<h3>
More Efficient than Query&nbsp;+ Trigger</h3>
We recommend using the fluent DSL or the <span style="font-family: Courier New, Courier, monospace;">RuntimeService.correlateMessage(...)</span> methods introduced in 7.0 over the Query&nbsp;+ Trigger pattern. Using the Query&nbsp;+ Trigger pattern you first query for an execution having a message event subscription and then trigger that execution:<br />
<br />
Not as efficient:<br />
<br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; // Query</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; Execution e = runtimeService.createExecutionQuery()</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; .processInstanceBusinessKey("someOrderId")</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; .messageEventSubscriptionName(</span><span style="font-family: 'Courier New', Courier, monospace;">"</span><b style="font-family: 'Courier New', Courier, monospace;">orderCancelled</b><span style="font-family: 'Courier New', Courier, monospace;">"</span><span style="font-family: 'Courier New', Courier, monospace;">)</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; &nbsp; .singleResult();</span><br />
<br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; variables.put("</span><span style="font-family: 'Courier New', Courier, monospace;">CANCEL_REASON</span><span style="font-family: Courier New, Courier, monospace;">",&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">"someReason"</span><span style="font-family: Courier New, Courier, monospace;">);</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; variables.put("</span><span style="font-family: 'Courier New', Courier, monospace;">CANCEL_TIMESTAMP</span><span style="font-family: Courier New, Courier, monospace;">",&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">new Date()</span><span style="font-family: Courier New, Courier, monospace;">);</span><br />
<span style="font-family: 'Courier New', Courier, monospace;"><br /></span>
<span style="font-family: 'Courier New', Courier, monospace;">&nbsp; // Trigger</span><br />
<span style="font-family: Courier New, Courier, monospace;">&nbsp; runtimeService.messageEventReceived("</span><b style="font-family: 'Courier New', Courier, monospace;">orderCancelled"</b><span style="font-family: Courier New, Courier, monospace;">, e.getId(), variables);</span><br />
<br />
The Query&nbsp;+ Trigger pattern has two disadvantages:<br />
<ol>
<li>More lines of code :)</li>
<li>Two process engine commands instead of a single one. This makes it less efficient in terms of performance.</li>
</ol>

</div>

      </div>

      <footer>
  <div>
    <div class="tags">
      <span class="glyphicon glyphicon-tag"></span>
      <ul class="list-inline">
        
          <li><a href="http://localhost:1313/tags/release-note">Release Note</a> </li>
        
      </ul>
    </div>

    <div class="author" id="author-badge">
      
  Daniel Meyer


    </div>
  </div>

  <div>
    <div class="next-post">
      <a href="/post/2014/03/new-camunda-bpm-network/">« New: camunda BPM network</a>
    </div>

    <div class="previous-post">
      <a href="/post/2014/03/camunda-grails-plugin-by-martin-schimak/">camunda Grails Plugin by Martin Schimak »</a>
    </div>
  </div>
</footer>


      <div class="comments">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

    </article>
  </div>

</div>




<footer>
  <div>
    <div class="boring-stuff">
      <ul class="list-inline">
        <li><a href="http://localhost:1313/misc/imprint">Imprint</a></li>
        <li><a href="http://localhost:1313/misc/privacy">Privacy Policy &amp; Cookies</a></li>
      </ul>
    </div>

    <nav class="networks text-center">
      <ul class="list-inline">
        <li>
          <a href="http://github.com/camunda">
            <span class="cam-blog-github"></span>
          </a>
        </li>
        <li>
          <a href="http://stackoverflow.com/questions/tagged/camunda">
            <span class="cam-blog-stackoverflow"></span>
          </a>
        </li>
        <li>
          <a href="http://twitter.com/camundabpm">
            <span class="cam-blog-twitter"></span>
          </a>
        </li>
        <li>
          <a href="https://vimeo.com/user22820658">
            <span class="cam-blog-vimeo"></span>
          </a>
        </li>
        <li>
          <a href="http://localhost:1313/index.xml">
            <span class="cam-blog-rss"></span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="back-to-top text-right">
      <a href="#">Back to top <span class="glyphicon glyphicon-chevron-up"></span></a>
    </div>
  </div>
</footer>

<script type="text/javascript" src="http://localhost:1313/js/scripts.js"></script>
<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

